# 基于 Docker Compose 的产品配置访问独立部署的服务

### 背景

产品中包含数据接入、时序数据存储等高负载应用，在部分场景下为了应对更多的流量，希望使用外部独立部署的高负载应用，因此，原来访问本地高负载应用的请求都需要转发到外部。

### 临时的解决方案

提取请求端的配置，默认情况下使用服务名发起请求，若有自定义配置需求，将其修改为独立部署的机器的 IP。

### 临时方案的问题/期望如何改进

1. 请求端不应该关心它应该使用产品内的服务还是外部的服务
2. 能够方便地切换到独立部署的服务

### 方案一

全部使用服务名访问。由于 Docker 内置 DNS 不能更改，所以这个大方案下可选的两个小方案为：

1.1）引入服务发现工具（如 Consul）做服务发现。缺点：增加复杂性

1.2）给所有请求端服务添加 hosts。缺点：改动大，增加部署复杂性

1.3）用小网关替代相应的本地服务。缺点：实现起来还是有些复杂，需要用到 docker compose 扩展，需要做环境变量注入

### 方案二

全部走网关。针对每一个独立部署的服务，只需要提取出一个配置，默认项为网关服务名，当需要独立部署时，修改配置为 IP，走独立部署服务的网关，再由后者转发到具体服务。

缺点：

1. 网关压力大，需要考虑使用更高性能的网关
2. 风险较高，网关如果挂掉，相关的服务也会挂掉
3. nginx 不能转发 tcp, udp，需要替代方案

### 确定最终方案

因为毕竟是要访问外部的服务，而服务名本身应该是用于内部的，而且综合考虑来说方案二的实现起来比较简单合理，因此最后选择方案二。