# 套接字原理

### 多个 socket 的端口号可以相同吗？
    
可以！

比如服务器使用 80 端口与多个客户端通信：
    
    服务器首先在 80 端口上创建一个监听套接字（listening socket），该套接字的任务是监听传入的连接请求。当来自客户端的连接请求到达时，服务器会为每个新的连接创建一个新的套接字。这个新的套接字与客户端的套接字共同构成了一条连接，服务器通过这条连接与客户端进行数据的接收和发送。
    
    因此，在处理多个客户端连接的服务器上，即使所有的连接都涉及到同一个服务器端口（如 80 端口），但实际上是有多个套接字存在的，每一个客户端连接都有一个唯一对应的套接字。所以，对于服务器来说，每个连接都是通过一个不同的套接字进行处理的。
    
    这样的设计使得服务器能够同时处理多个并行连接，每个连接都有自己的套接字和独立的缓冲区，这使得服务器能够独立地接收和发送每个连接的数据，而不会混淆不同连接的数据。
    

但是一般来说同一个机器上不能使用同一个端口创建 2 个套接字，除非协议不一样。

ChatGPT
    
    在一般情况下，你不能在同一个机器上使用同一个端口创建两个套接字，因为端口号被设计用来在操作系统级别唯一地标识一个网络连接。这是因为每个 TCP 或 UDP 连接被唯一地标识为一个四元组：源 IP 地址、源端口、目标 IP 地址和目标端口。如果你尝试在同一台机器上用同一个端口创建两个套接字，你通常会收到一个错误，告诉你该端口已被占用。
    
    然而，有一种情况下你可以在同一个端口上创建多个套接字，那就是你使用的是 TCP 和 UDP 不同的协议。因为 TCP 和 UDP 是两个不同的协议，所以它们在系统中是分别管理的。也就是说，你可以在同一台机器上为 TCP 创建一个套接字并绑定到一个端口，同时为 UDP 创建另一个套接字并绑定到同一个端口。
    
    还有一种可能是当你设置了套接字选项 SO_REUSEADDR 或 SO_REUSEPORT（取决于你的操作系统），这会允许多个套接字绑定到同一个端口，但这通常只在特定的使用场景下有用。
    
    总的来说，如果你不是在处理特殊的使用场景（比如要处理多播或广播数据），那么你应该避免在同一台机器上使用同一个端口创建两个套接字，因为这会引起数据交错和混淆。
        
### TCP/IP 网络中，一个完整的网络连接包含什么？
    
在TCP/IP网络中，一个完整的网络连接包括四个元素：源IP地址、源端口、目标IP地址、目标端口。这四个元素组合在一起，唯一地确定了一个网络连接。（或者换一个说法：一个客户端的 socket 和一个服务端的 socket 组成了一条连接）（也就是说，每个套接字都对应一个唯一的客户端连接）

对于服务器来说，它通常会在一个特定的端口（比如HTTP服务器通常在80端口）监听所有传入的连接请求。当一个客户端发起连接请求时，服务器会为这个特定的连接创建一个新的套接字。即使这个新套接字的端口号和监听套接字的端口号相同，但是由于客户端的IP地址和端口号的不同，所以这个新套接字仍然是唯一的。

例如，假设有两个客户端，IP地址分别为192.0.2.1和192.0.2.2，它们都从自己的1024端口连接到服务器的80端口。对于服务器来说，这两个连接是唯一的，因为每个连接的源IP地址和源端口都不同：

- 连接1: 源IP 192.0.2.1，源端口 1024，目标IP [服务器IP]，目标端口 80
- 连接2: 源IP 192.0.2.2，源端口 1024，目标IP [服务器IP]，目标端口 80

### 一个 socket 可以在多个进程之间共享吗？
    
    
一般来说，套接字（socket）不会在多个进程之间共享。但是，当父进程创建一个套接字并随后生成一个或多个子进程时，这些子进程将继承父进程的文件描述符，包括其套接字。这样，父进程和它的子进程就可以共享这个套接字。

不过，要注意的是，即使这样，套接字的并发使用也需要小心处理。例如，如果多个进程同时写入套接字，可能会导致数据交错和混乱。因此，通常需要一些形式的同步或者序列化，比如使用互斥锁、信号量等手段，或者设计协议使每个进程只在特定时间写入。

此外，一种更常见的方式是让一个进程管理所有的套接字，而其他进程通过某种形式的进程间通信（IPC）将其数据发送给该进程，由它负责将数据写入套接字。这样可以避免许多并发写入的问题。

最后，要注意的是，虽然多个进程可以共享一个套接字，但这并不意味着他们可以同时接收同一套接字的数据。一旦其中一个进程从套接字读取数据，那些数据就会从系统缓冲区中移除，其他进程就无法再次读取。因此，如果多个进程需要处理同一套接字的数据，你可能需要实现某种形式的数据分发逻辑。
    
### ss 和 netstat 命令有什么异同？
    
`ss`（socket statistics）和 `netstat`（network statistics）都是用于查看网络连接和套接字信息的工具，都能在 Unix 或 Unix-like 系统（比如 Linux）上使用。然而，这两个命令在某些方面有所不同，以下是它们的一些异同点：

相同点：

1. `ss` 和 `netstat` 都可以用于查看网络连接状态，包括 TCP 连接、UDP 连接、UNIX 套接字等。
2. 它们都可以显示各种详细信息，如端口号、使用的协议、连接状态（如 LISTEN、ESTABLISHED 等）、进程 ID 和名称等。

不同点：

1. **性能**：`ss` 在处理大量的网络连接时，比 `netstat` 更快、更高效。这是因为 `ss` 使用了 Linux 内核提供的 `inet_diag` 功能，而 `netstat` 则扫描 `/proc` 文件系统，这在大量连接的情况下会更慢。
2. **详细信息**：`ss` 能提供 `netstat` 无法提供的一些信息，如 TCP 和 SCTP 的内部详细信息（例如，每个连接的接收和发送队列的大小）。
3. **过滤功能**：`ss` 提供了比 `netstat` 更强大的过滤功能，可以按协议、状态、地址、端口等多种方式过滤套接字。
4. **支持**：在新的 Linux 发行版中，`netstat` 命令逐渐被 `ss` 替代。`netstat` 是 `net-tools` 包的一部分，而这个包已经很长时间没有更新了。`ss` 是 `iproute2` 工具包的一部分，这个包是目前 Linux 内核网络功能的主要维护工具包。

这是 `ss` 和 `netstat` 的基本异同点，它们都是非常有用的网络诊断工具，可以帮助你查看和理解网络连接和套接字的状态。你可以根据你的具体需求和习惯选择使用哪一个工具。