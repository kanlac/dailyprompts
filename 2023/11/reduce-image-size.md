# 如何减少镜像大小

- 使用尽量小的基础镜像，比如 scratch, busybox 或者 alpine
- 避免使用相同镜像的不同版本
- 如果拷贝了项目目录，避免不必要的拷贝，比如把 .git 和 test 目录加入到 .dockerignore
- 尽量减少 RUN 的使用（减少层）
    
    但整合成一个 RUN 不好的地方就是本地调试构建很慢，不能利用层缓存特性。所以最好的做法是开发调试时分层，发布时再整合成一个 RUN。
    
    `RUN` 命令在 Dockerfile 中每执行一次都会创建一个新的层。这是 Docker 镜像的特性，每一层都是上一层的增量更改。使用多个 `RUN` 命令意味着你的最终镜像将有更多的层。
    
    将多个操作组合成单个 `RUN` 命令可以减少生成的层的数量，这对生产镜像有以下好处：
    
    1. **减少镜像大小**：尽管每一层都是增量的，但多层可能会导致额外的空间浪费。例如，如果你在一个层中添加了一个文件，然后在另一个层中删除了它，这两个层仍然会被包含在最终的镜像中，即使文件在最终镜像中并不存在。
    2. **加快镜像拉取和推送**：当你从 Docker Hub 或其他仓库中拉取或推送镜像时，镜像的每一层都需要单独拉取或推送。减少层数量可以加快这一过程。
    3. **提高存储效率**：与上述相关，少的层数量可以提高存储效率，尤其是在使用 OverlayFS 或其他基于层的存储驱动时。
    4. **简化构建过程**：将多个步骤组合成一个 `RUN` 命令有时可以简化构建逻辑，因为你可以在一个命令中执行多个相关操作。
    
    然而，也有一些情况下，你可能希望或需要保留多个 `RUN` 命令：
    
    1. **利用缓存**：Docker 会缓存每一层的结果。如果你的 Dockerfile 中的早期步骤不经常更改，但后期步骤经常更改，将它们分成多个 `RUN` 命令可以加速再次构建的过程，因为 Docker 可以重用缓存的早期层。
    2. **清晰和可读性**：在某些情况下，为了保持 Dockerfile 的清晰和可读性，将命令分成多个 `RUN` 指令可能更有意义。
    3. **调试**：在开发和调试过程中，多个 `RUN` 命令允许你更精确地定位问题。
    
    总之，为了构建优化和大小效率，建议在生产的 Docker 镜像中尽量减少 `RUN` 命令的数量。但在开发和调试过程中，可能需要权衡其他考虑因素。