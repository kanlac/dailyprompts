# 容器核心技术

- 容器相对虚拟机的优势是没有额外的性能损耗，缺点则是隔离的不够彻底，用的还是相同的内核。比如在容器里执行 `top`，看到的依然是宿主机的内存和 CPU 的信息，这是因为 /proc 文件系统并不了解 Cgroup 的存在。又比如容器通过 `settimeofday(2)` 系统调用修改时间，那么整个宿主机的时间都会随之被修改。虽然有 Seccomp 等技术限制容器可以发起的系统调用，但是也不能完美地兼顾性能和隔离性
- Namespace 用于实现进程隔离，Cgroup 则用于实现资源限制。Cgroup 提供文件系统作为使用接口，在 /sys/fs/cgroup 下面编辑相应的文件，并填入 PID，Linux 就会将相关资源限制应用到进程。实际上 [服务资源限制](https://www.notion.so/de46b5b69705499885a4fd30ab82c976?pvs=21)也是通过修改 Cgroup 文件系统来实现的。
- Docker 核心原理之三：切换进程的根目录。有这么一个简单的小实验：把 bash 命令和它的依赖都拷贝到一个 test 目录下，并使用 `chroot` 命令（在 Docker 中则可能是 `pivot_root` ）修改 `bash` 二进制的根目录：`chroot test /bin/bash`。现在执行 `ls /` ，会看到它返回的都是 test 目录下的内容，说明它的根文件系统（rootfs）已经被修改

总结：

1. Cgroup
2. Namespace
3. 分层镜像，也就是在 rootfs 的基础上，使用多个增量 rootfs 联合挂载一个完整的 rootfs 的方案。解决了最大的依赖库——操作系统——的问题，实现了强一致性，打通了开发-测试-部署的每一个环节。注意它是复制了操作系统但没有复制内核，所有容器的内核是共享的