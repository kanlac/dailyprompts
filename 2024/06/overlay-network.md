# 容器跨主机网络

## Q
- flannel 的作用
- flannel0 是一种 TUN 设备，这种类型的网络设备起什么作用？
- 简述 UDP 实现下容器 IP 包的跨主机通讯过程，并说明发生了哪几次内核态用户态切换

## Flannel 的作用

给容器分配 IP 地址，并在 k8s 中构建覆盖网络（overlay network），实现容器跨主机网络通信。

## Flannel 后端实现

Flannel 框架支持的后端实现有 3 种：

1. VXLAN
2. host-gw
3. UDP

UDP 因为性能问题已经被废弃，但这种模式最直接最易理解。因此先理解 UDP。

前提知识：

1. TUN 设备是一种**在内核态和用户态之间传递 IP 包**的网络设备，它在**三层（网络层）**工作
2. Flannel 管理的网络中，一台宿主机上的所有容器都属于该宿主机被分配的一个子网，Flannel 管理这些子网，知道哪些地址需要发往哪个节点，这些子网与宿主机的关系保存在 etcd 中，可以通过 `etcdctl` 命令查看
3. 每个宿主机上的 flanneld 进程都监听 8252 端口
4. 可以根据 ip route 命令查看本机各网段路由

Node1 上的容器访问 Node2 上的容器，经过如下过程：

1. 容器出来的网络包，从用户态到内核态（第一次切换），先尝试给 docker0 处理，但因为不在 docker0 网段，所以会从 docker0 出来到宿主机上
2. 匹配到了 flannel0 设备，它是一个 TUN 设备，交由 flanneld 进程处理，从内核态到了用户态（第二次切换）
3. flanneld 在 etcd 中查找到目标主机的地址，封装到 UDP 包中经由 eth0 发送到 Node2 的 8252 端口（第三次切换）

Node2 上 flanneld 进程从 UDP 包中解封出 IP 包，发送到 flannel0 设备，后面的过程跟发出时正好相反。

从上面过程可以看到，光是将 IP 包发出就需要经过三次内核态用户态之间的切换，因此说 UDP 模式有严重的性能问题。
