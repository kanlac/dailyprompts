# 基于客户端 IP 的流量转发

## 进入 K8S 的外部请求，什么情况下会丢失源 IP？如何应对？

1. 使用了（外部负载均衡器和）LoadBalancer Service，SNAT 操作会导致源 IP 丢失。可以配置 `externalTrafficPolicy: Local`，让数据包绕过节点上的 kube-proxy，直达 Pod，这样就可以保留源 IP，但会产生副作用：1）只有已经运行了目标 Pod 的节点的请求会被处理；2）流量分布不均
2. 通过 Ingress 控制器的七层协议，可能会丢失源 IP，一般可以配置是否保留源 IP
3. 通过 Nginx-Ingress 的四层协议，实际验证会丢失源 IP，且没有直接的配置可以改变这个行为。解决方案：1）编写负载均衡扩展脚本自行实现基于源 IP 的哈希；2）使用 Proxy Protocol，它可以在 UDP 报文头中传递源 IP 信息

## 什么是 SNAT 操作？为什么它会导致源 IP 丢失？

SNAT（源网络地址转换，Source Network Address Translation）是一种网络地址转换技术，用于在IP数据包离开网络时改变源IP地址（和可能的端口号）。这通常用于内网环境中，让使用私有IP地址的主机能够与外网通信，或在负载均衡器、NAT网关等网络设备上实现流量的路由和管理。

### SNAT的工作原理：

- **转换过程**：当内网设备（如私有IP地址的计算机）向外网发送请求时，SNAT会将数据包的源地址（私有IP）替换为公共IP地址（可能是固定的或动态选取的）。这样，外网上的服务器或服务看到的是公共IP地址，而不是发送请求的内部设备的私有IP地址。
- **响应路由**：外网对请求的响应将发送到经过SNAT转换的公共IP地址。SNAT设备根据之前建立的映射表，将响应数据包的目标地址从公共IP地址转换回原始的私有IP地址，确保响应能正确地返回给发起请求的内部设备。

### 是否会导致源IP丢失？

**是的**，SNAT操作会导致源IP地址在转换过程中“丢失”：

- **对于外部服务**：由于SNAT将内部源IP地址替换为公共IP地址，因此外部接收者看到的是经过转换的公共地址，而不是原始的内部地址。这意味着，对于接收到的连接请求，外部服务无法知道最初的内部源IP地址。
- **对于跟踪和日志**：这种IP地址的改变可能会对网络监控、跟踪和安全审计带来挑战，因为原始的源IP信息在到达外部目标时不再可见。

### 为什么会这样？

这种设计主要出于以下几个原因：

- **安全性**：隐藏内部网络的结构和IP地址，可以为内网设备提供一定程度的匿名性和安全保护。
- **IP地址节省**：使用SNAT可以让多个内网设备共享一个或少量公共IP地址与外网通信，有效缓解了IPv4地址枯竭的问题。
- **内外网络隔离**：SNAT为内外网络提供了一层隔离，有助于控制进出内网的流量，以及实现对内网访问外网行为的管理。

总之，SNAT是一种在将内网流量转发到外网时广泛使用的技术，它通过替换源IP地址来实现地址转换和流量路由，但这种做法也导致了原始源IP信息的丢失，影响到了对源IP地址的直接访问和识别。
